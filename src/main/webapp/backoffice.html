<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Бэкоффис</title>
    <link rel="stylesheet" href="/static/css/lib/jquery-ui-1.10.3.full.min.css" />
<link rel="stylesheet" href="/static/css/style.css" />
<link rel="stylesheet" href="/static/css/backoffice.css" />

<!--[if lt IE 9]>
    <script>
        document.createElement('header');
        document.createElement('section');
        document.createElement('footer');
        document.createElement('aside');
        document.createElement('nav');
    </script>
    <![endif]-->

</head>
<body>
<div class="navbar navbar-default" id="navbar">
    <script type="text/javascript">
        try {
            ace.settings.check('navbar', 'fixed')
        } catch (e) {
        }
    </script>

    <div class="navbar-container" id="navbar-container">
        <div class="navbar-header pull-left">
            <a href="#" class="navbar-brand">
                <img src="/static/i/logo.png" alt="логотип"/>
            </a>
        </div>

        <div class="navbar-header pull-right" role="navigation">
            <ul class="nav ace-nav">
                <li><a class="btn btn-info no-border private-messages-link"
                                                                  href="#">Личные сообщения </a></li>

                <li><a class="btn btn-info no-border nextdoors-link"
                                                            href="#"> Соседи</a></li>

            </ul>
        </div>

    </div>
</div>

	<div class="container coming-soon backoffice">

		<div class="main-container" id="main-container">
			<div class="main-container-inner">
                <br>
                <br>
                <h2>Добавить пост в блог.</h2>
                <input placeholder="Ссылка на пост" class="post-url" type="text"/>

                <button class="btn no-border btn-sm btn-primary send-post">Отправить</button>

                <div class="bo-business">
                    <h2>Добавить Business-page</h2>
                    <div><input placeholder="Ссылка на краткое описание" class="bus-short-url" type="text"/></div>
                    <p></p>
                    <div><input placeholder="Ссылка на полное описание" class="bus-full-url" type="text"/></div>
                    <p></p>

                    <button class="btn no-border btn-sm btn-primary send-business">Отправить</button>
                </div>

                <div class="bo-edit">
                    <h2>Редактирование сообщения</h2>
                    <div><input placeholder="id" class="msg-id" type="text"/></div>
                    <p></p>
                    <div>
                        <input placeholder="groupId" class="groupId" type="text"/>
                    </div>
                    <p></p>
                    <div>
                        <div class="dropdown">
                            <button id="msgType" type="button" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" role="button" aria-expanded="false">
                                Тип сообщения
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" role="menu" aria-labelledby="msgType">
                                <li data-param="5">Wall</li>
                                <li data-param="1">Talks</li>
                                <li data-param="6">Advert</li>
                            </ul>
                        </div>
                    </div>
                    <p></p>
                    <div>
                        <div class="dropdown">
                            <button id="groupType" type="button" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" role="button" aria-expanded="false">
                                Тип группы
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" role="menu" aria-labelledby="groupType">
                                <li data-param="0">Nobody</li>
                                <li data-param="2">Floor</li>
                                <li data-param="3">Staircase</li>
                                <li data-param="4">Building</li>
                                <li data-param="5">Neighbours</li>
                                <li data-param="6">Block</li>
                                <li data-param="7">District</li>
                            </ul>
                        </div>
                    </div>
                    <p></p>
                    <div>
                        <div><input placeholder="широта" class="msg-lat" type="text"/></div>
                        <div><input placeholder="долгота" class="msg-long" type="text"/></div>
                    </div>
                    <p></p>

                    <button class="btn no-border btn-sm btn-primary edit-message">Отправить</button>
                </div>

                <div class="broadcast">
                    <br/>
                    <h2>Отправить уведомление пользователям.</h2>
                    <div><input class="broadcast-code" type="text" placeholder="Код группы"/></div>
                    <p></p>
                    <div><textarea class="broadcast-message">Сообщение</textarea></div>
                    <p></p>
                    <button class="btn btn-sm no-border btn-primary send-broadcast">Разместить</button>
                </div>

                <div>
                    <h2>Иниициализация счетчиков</h2>
                    <div class="bo-counter-item"><input type="text" class="counter-buildingid" placeholder="Building id" /></div>
                    <div class="bo-counter-item"><input type="text" class="counter-startdate" placeholder="start date" /></div>
                    <div class="bo-counter-item"><input type="text" class="counter-enddate" placeholder="end date" /></div>

                    <div class="bo-counters">
                        <a href="#" class="addCounter pull-right">Добавить</a>
                        <div class="bo-counter-select">
                            <select>
                                <option value="0">Горячая вода</option>
                                <option value="1">Холодная вода</option>
                                <option value="2">Эл-во общий</option>
                                <option value="3">Эл-во ночь</option>
                                <option value="4">Эл-во день</option>
                                <option value="5">Газ</option>
                                <option value="6">Другое</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn btn-sm no-border btn-primary init-counter">Инициализировать</button>
                    <span class="counter-init-status "></span>

                </div>

                <div class="cabinet-edit">
                    <h2>Создание кабинета для бизнеса</h2>

                    <!--<div class="block clearfix logo-container clearfix">
                        <div>Логотип</div>

                        &lt;!&ndash;<div class="pull-left avatar big" ng-style="{'background-image': 'url(' + edit.businessDescription.logo.URL + ')' }"></div>&ndash;&gt;
                        <div class="pull-left logo"><img ng-src="{{edit.businessDescription.logo.URL}}" alt=""/></div>

                        <label class="btn btn-sm btn-primary no-border pull-left load-avatar">
                            Загрузить
                            <input type="file" class="logo-input" uploader="uploaderLogo" />
                        </label>

                        <div ng-repeat="item in uploaderLogo.queue" ng-show="uploaderLogo.isHTML5 && !uploaderLogo.queue.length" ng-thumb="{ file: item._file, height: 100 }"></div>

                    </div>

                    <div class="block clearfix logo-container clearfix">
                        <div>Иллюстрация</div>

                        <div class="pull-left images"><img ng-src="{{edit.businessDescription.images[0].URL}}" alt=""/></div>

                        <label class="btn btn-sm btn-primary no-border pull-left load-avatar">
                            Загрузить
                            <input type="file" nv-file-select="" uploader="uploaderImages" />
                        </label>

                        <div ng-repeat="item in uploaderImages.queue" ng-show="uploaderImages.isHTML5 && !uploaderImages.queue.length" ng-thumb="{ file: item._file, height: 100 }"></div>
                    </div>-->

                    <label>
                        <span>Имя пользователя</span>
                        <input type="text"  class="business-username"/>
                    </label>
                    <label>
                        <span>Пароль</span>
                        <input type="password"  class="business-pass"/>
                    </label>
                    <label>
                        <span>Название</span>
                        <input type="text" class="business-name" />
                    </label>
                    <label>
                        <input type="file" class="business-logo"/>
                    </label>
                    <label>
                        <input type="file"  class="business-images" multiple/>
                    </label>
                    <label>
                        <span>Короткое описание</span>
                        <input type="text"  class="business-shortDescr"/>
                    </label>
                    <label>
                        <span>Адрес</span>
                        <input type="text"  class="business-address"/>
                    </label>
                    <label>
                        <span>longitude</span>
                        <input type="text"  class="business-longitude"/>
                    </label>
                    <label>
                        <span>latitude</span>
                        <input type="text"  class="business-latitude"/>
                    </label>
                    <label>
                        <span>Радиус</span>
                        <input type="text"  class="business-radius"/>
                    </label>

                    <div class="cabinet-descr">
                        <div>Полное описание</div>
                        <textarea class="business-fullDescr"></textarea>
                    </div>

                    <button class="btn btn-sm btn-primary no-border save-cabinet">Сохранить</button>

                </div>
			</div>
		</div>

	</div>

<script src="/static/js/lib/jquery-2.0.3.js"></script>
<script src="/static/js/lib/bootstrap.min.js"></script>
<script src="/static/js/lib/ace.min.js"></script>
<script src="/static/js/lib/ace-extra.min.js"></script>
<script src="/static/js/ace-elements.js"></script>
<!-- файлы thrift -->
<script src="/static/js/thrift.js" type="text/javascript"></script>
<script src="/gen-js/bedata_types.js" type="text/javascript"></script>
<script src="/gen-js/messageservice_types.js" type="text/javascript"></script>
<script src="/gen-js/MessageService.js" type="text/javascript"></script>
<script src="/gen-js/userservice_types.js" type="text/javascript"></script>
<script src="/gen-js/UserService.js" type="text/javascript"></script>
<script src="/gen-js/utilityservces_types.js" type="text/javascript"></script>
<script src="/gen-js/UtilityService.js" type="text/javascript"></script>
<script src="/gen-js/business_types.js" type="text/javascript"></script>
<script src="/gen-js/BusinessService.js" type="text/javascript"></script>
<script src="/gen-js/fileutils_types.js" type="text/javascript"></script>
<script src="/gen-js/FileService.js" type="text/javascript"></script>
<!-- -->



<script type="text/javascript">
    $(document).ready(function(){
        var transport = new Thrift.Transport("/thrift/MessageService");
        var protocol = new Thrift.Protocol(transport);
        var messageClient = new com.vmesteonline.be.thrift.messageservice.MessageServiceClient(protocol);

        transport = new Thrift.Transport("/thrift/UserService");
        protocol = new Thrift.Protocol(transport);
        var userClient = new com.vmesteonline.be.thrift.userservice.UserServiceClient(protocol);

        transport = new Thrift.Transport("/thrift/UtilityService");
        protocol = new Thrift.Protocol(transport);
        var utilityClient = new com.vmesteonline.be.thrift.utilityservice.UtilityServiceClient(protocol);

        transport = new Thrift.Transport("/thrift/BusinessService");
        protocol = new Thrift.Protocol(transport);
        var businessClient = new com.vmesteonline.be.thrift.businesservice.BusinessServiceClient(protocol);

        transport = new Thrift.Transport("/thrift/fs");
        protocol = new Thrift.Protocol(transport);
        var fileClient = new com.vmesteonline.be.thrift.fileservice.FileServiceClient(protocol);


        var title,logoURL,logoName,logoType,
                business_images = [];

        $('.business-logo').ace_file_input({
            style:'well',
            btn_choose:'Загрузить логотип',
            btn_change:null,
            no_icon:'',
            droppable:false,
            thumbnail: 'large',
            icon_remove:null,
            before_change: function(files, dropped){
                title = $(this).find('+.file-label').data('title');
                return true;
            }
        }).on('change', function(){
            var fileLabel = $(this).find('+.file-label');

            setTimeout(copyImage, 200,fileLabel,'logo');

        });

        function copyImage(fileLabel,type){

            if(type == 'logo'){
                var copyImgSrc = fileLabel.find('.file-name img').css('background-image');

                if (copyImgSrc == 'none' || !copyImgSrc) {
                    setTimeout(copyImage, 200,fileLabel,'logo');
                } else {
                    logoURL = fileClient.saveFileContent(copyImgSrc, true);
                    logoName = fileLabel.find('.file-name').data('title');

                    console.log($('.business-logo')[0].files);
                    //logoType = $('.business-logo')[0].files[0].type;
               }

            }else{
                var files = $('.business-images')[0].files,
                    len = files.length;

                for(var i = 0; i < len; i++){
                    business_images[i] = new com.vmesteonline.be.thrift.messageservice.Attach();
                    business_images[i].contentType = files[i].type;
                };

                i = 0;
                var copyImgSrc = [];
                fileLabel.find('.file-name').each(function(){

                    copyImgSrc[i] = $(this).find('img').css('background-image');

                    business_images[i].URL = fileClient.saveFileContent(copyImgSrc[i], true);
                    business_images[i].fileName = $(this).data('title');

                    i++;
                })
            }

        }

        $('.business-images').ace_file_input({
            style:'well',
            btn_choose:'Загрузить слайды',
            btn_change:null,
            no_icon:'',
            droppable:false,
            thumbnail: 'small',
            icon_remove:null,
            before_change: function(files, dropped){
                title = $(this).find('+.file-label').data('title');
                return true;
            }
        }).on('change', function(){
            var fileLabel = $(this).parent();

            setTimeout(copyImage, 200,fileLabel);

        });

        $('.send-post').click(function(e){
            e.preventDefault();
            var groups = userClient.getUserGroups();

            var newTopic = new com.vmesteonline.be.thrift.messageservice.Topic();
            newTopic.message = new com.vmesteonline.be.thrift.messageservice.Message();
            newTopic.message.groupId = groups[0].id;
            //newTopic.message.topicId = 0;
            newTopic.message.type = 7; // blog
            newTopic.message.content = $('.post-url').val();
            newTopic.message.id = 0;
            newTopic.message.created = Date.parse(new Date())/1000;

            newTopic.subject = "123";
            newTopic.id = 0;

            messageClient.postTopic(newTopic);
        });

        $('.send-business').click(function(e){
            e.preventDefault();
            var groups = userClient.getUserGroups(),
                shortUrl = $('.bus-short-url').val(),
                fullUrl = $('.bus-full-url').val();

            console.log('bus-page');
            if(shortUrl && fullUrl){
                var newTopic = new com.vmesteonline.be.thrift.messageservice.Topic();
                newTopic.message = new com.vmesteonline.be.thrift.messageservice.Message();
                newTopic.message.groupId = groups[0].id;
                //newTopic.message.topicId = 0;
                newTopic.message.type = 8; // business page
                newTopic.message.content = shortUrl+";"+fullUrl;
                newTopic.message.id = 0;
                newTopic.message.created = Date.parse(new Date())/1000;

                newTopic.subject = "123";
                newTopic.id = 0;

                console.log('bus-page',newTopic.message.content);
                var t = messageClient.postTopic(newTopic);
                console.log('bus-page',t);
            }
        });

        $('.dropdown-menu li').click(function(){
            var text = $(this).text()+'<span class="caret"></span>',
                param = $(this).attr('data-param'),
                header = $(this).closest('.dropdown').find('.dropdown-toggle');

            console.log(param);
            header.html(text).attr('data-param',param);
            console.log(header.attr('data-param'));
        });

        $('.edit-message').click(function(e){
            e.preventDefault();

            var id = $('.msg-id').val(),
                groupId = $('.groupId').val() || null,
                long = $('#msg-long').val() || null,
                lat = $('#msg-lat').val() || null,
                msgType = $('#msgType').attr('data-param'),
                groupType = $('#groupType').attr('data-param');

            console.log($('#msgType').length,msgType,groupType);

            messageClient.moveTopic(id,groupId,long,lat,groupType,msgType);

        });

        $('.send-broadcast').click(function(){
           var message = $('.broadcast-message').val(),
               code = [],
               startDate = Date.parse(new Date())/1000,
               expireDate = startDate+7*24*3600;

            code[0] = parseInt($('.broadcast-code').val());

            console.log(code[0]+" "+startDate+" "+message+" "+expireDate);

            messageClient.sendGroupMulticastMessage(code,message,startDate,expireDate);
        });

        $('.addCounter').click(function(e){
            e.preventDefault();

            var counterHtml = '<div class="bo-counter-select"><select>'+
                    '<option value="0">Горячая вода</option>'+
            '<option value="1">Холодная вода</option>'+
            '<option value="2">Эл-во общий</option>'+
            '<option value="3">Эл-во ночь</option>'+
            '<option value="4">Эл-во день</option>'+
            '<option value="5">Газ</option>'+
            '<option value="6">Другое</option>'+
            '</select></div>';

            $(this).parent().append(counterHtml);
        });

        $('.init-counter').click(function(){
            var buildingId = parseInt($('.counter-buildingid').val()),
                    startDate = parseInt($('.counter-startdate').val()),
                    endDate = parseInt($('.counter-enddate').val()),
                    countersList = [],ind = 0;

            $('.bo-counters select').each(function(){
                countersList[ind++] = parseInt($(this).find('option:selected').val());
            });

            console.log(buildingId+" "+startDate+" "+endDate);
            console.log(countersList);

            utilityClient.createCounterService(buildingId,startDate,endDate,countersList);

            $('.counter-init-status').addClass('info-good').text('Успешно');
        });

        $('.save-cabinet').click(function(){

            var username = $('.business-username').val(),
                pass = $('.business-pass').val(),
            businessDescription = new com.vmesteonline.be.thrift.businesservice.BusinessDescription;
            businessDescription.shortName = $('.business-name').val();
            //businessDescription.fulltName = "Мега Пицца круто-круто";
            businessDescription.shortInfo = $('.business-shortDescr').val();
            businessDescription.fullInfo = $('.business-fullDescr').val();
            businessDescription.address = $('.business-address').val();
            businessDescription.longitude = $('.business-longitude').val();
            businessDescription.latitude = $('.business-latitude').val();
            businessDescription.radius = $('.business-radius').val();

            businessDescription.logo = new com.vmesteonline.be.thrift.messageservice.Attach();
            businessDescription.logo.fileName = logoName;
            businessDescription.logo.contentType = logoType;
            businessDescription.logo.URL = logoURL;

            businessDescription.images = business_images;

            console.log('save',businessDescription.images);

            //var svc = fileClient.saveFileContent(fileBase64, true);

            console.log('save',businessDescription,username);

            businessClient.createBusinessDescription(businessDescription,username,pass);

            console.log('save fin');
        });

    });
</script>

</body>


</html>
